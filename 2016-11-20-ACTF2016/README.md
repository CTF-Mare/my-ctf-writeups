# ACTF 2016 Writeups

## 说明
看了看之前的 Writeups，发现这个章节快要变成碎碎念时间了...

这次是我在转离技术岗位后第一次做技术类的比赛（别吐槽这句话，我也不知道怎么评价……），感觉就是题还是会做的，但是个人时间确实是没多少了[删除]明明是继续沉迷守望不能自拔[/删除]（胡说明明还在通宵看爽哥打秋活），再加上服务器在内网，而我内网通道已经全部爆炸（感谢 G20），所以所有要用工具做的题（包括但不限于大部分的 Web、Reverse 题以及全部 Pwn 题……）是做不了的，于是我爽快地敲出了 gege...

因此这份题目做的断断续续的，最后结果也不尽如人意，至少对我来说是这样——一场比赛只面向校内，校内大部分有点水平或兴趣的都在 AAA 里，剩下的人里我还能掉出前三，尽管我自认为是初学者也没用心做，但这种成绩肯定也是交不了差的……只能说好好反思总结，别打杂打的把技术忘光光了，也不能再划水了，重视基础和积累才是王道...

当然话又说回来了，菜就要站着挨打，做的不好是不能用没用心做来搪塞的，不会做的题再给我 24 个小时我也是不会做。Pwn 题我还是肉身去学校蹭了一下网络（做题地点：31 舍楼下以及教超隔壁，噗嗤）的，但确实在电脑电量用完之前我没做出来，那就认菜，没什么可说的……

回到比赛本身的话，作为目前全勤参加 ACTF，第二次以选手参赛（总共三届，第二届我是出题人之一）的视角来看，这次比赛简单题质量确实乏善可陈，我一向认为简单题也是能出的有趣、给新加入这个领域的人一个好的示范的，而我认为这次题目可能达不到这个要求（当然我出题那一年就更不行，多亏了凯神噗嗤）。但如果熬过前面的题目部分，后面的题目感觉有不少亮点，对于有一定水平的同学来说应该也算是不错的体验。

运维方面，这次主办没有认真考虑到被 D 的情况还是有些欠缺了，大家都知道被 D 是常态的情况下似乎没有什么防范措施，直接被打爆了...然后似乎因为被打爆延时了，但在网页上没有任何告示...然后比赛暂停似乎只是平台暂停了，题目服务器好像全开着？我不太确定这种做法是不是目前通用的做法（因为我不怎么做比赛...），当年我们是全部服务器都关掉、文件下载也停止的，也许主办方考虑有不同吧233，总而言之第一天的问题确实不少。第二天就好多了。

总而言之还是十分感谢 AAA 的大佬们，让我在微博上的吐槽没有成真，没有让这比赛办着办着办没了（噗嗤），祝福 AAA 大佬们在之后比赛上继续取得佳绩吧~

P.S：MD 这次比赛后我感觉我的地理变好了，错觉吗

## 题解

### Afghanistan - songmingti
上 Stegsolve，发现有两帧，没了

### India - easy reversing
简单题，对输入字符串先按下标位移，再交换顺序，反着做一次就行。我人肉交换顺序爆炸了，最后一怒之下从 Hex 上直接复制代码跑的（噗嗤

### Finland - miaomiaomiao
这题能给负分吗？我一直以为这个年代没有工具题了，结果还真就撞上一道...卡题良久，最后总算是猜到有可能有奇怪的工具，下了半打工具后发现 Steghide 可解，出来一个字符串里面有 240 长度的 01 串，是 8 的倍数，直接按 8 拆后转成字符即可。

### Iceland - 大乌龟找妈妈
。。。。。。。好像是给新人准备的题目，给了至少一打提示，笑炸……当然也主要是因为这题确实比较……恶心，新人大概会感觉到被打击（死

* 第一部分：首页注释
* 第二部分：首页 HTTP 头，base64 解不出来就要知道一个叫 base32 的东西...
* 第三部分：robots.txt 里有两个文件，有个 txt
* 第四部分：另外一个文件跳转到 register，cookie 里
* 第五部分：跳转前的文件里（凸槽一下，Chrome 下看不到，我又抓不到包（感谢伟大的垃圾 RVPN...），于是最后只能被迫叫同学帮我抓包，简直是蠢炸……）

### United States - CY 的魔幻之旅
这题最大的提示出现在代码部分的这里：`http://www.melodia.pw`，在学习了一个后比较容易发现这题是个拼凑题的本质，所以我很不喜欢这道题，因为拼凑题没什么意思……

回到题目本身，题目要求提交一个 url，如果 url 符合条件则会反序列化一个字符串，这实际上就是两个题。

先看第一部分 url 检查，它要求 url 开头为 `http://www.melodia.pw`，并且后面不能紧跟着 `@`，还有代码中不能出现 `172 192 10 localhost 127`（不知道为什么……），最后还要求 PHP 的 `parse_url` 可以将 host 解析成 `gov.cn`（你们真不怕有人去黑吗hhhhh）。

第一部分很好处理，由于 URL 本身根本不做任何用途，所以实际上你根本不用考虑这个 URL 是否合法……但算了我们还是搞个合法的吧，首先第一部分可以用这种方法绕过去：`http://www.melodia.pw.icpc.moe`，但还有 host 的限制，就需要搞这个 `parse_url`，而这个 `parse_url` 跟 PHP 本身的漏洞一样多（，所以最后结果是

`http://www.melodia.pw.icpc.moe@gov.cn`

嗨呀我昨天明明写了一个很吊的例子，想不起来了，但这个也能用……

后面的部分，你在`http://www.melodia.pw`上搜 wakeup 就有两个地方告诉你改大序列化字符串的对象数量可以在反序列化时跳过执行 wakeup 方法，所以……就这样了咯。注意 private 属性在序列化时会被`%00` + 类名 + `%00` 作为前缀，实在不会动手改改 PHP 代码序列化输出一个空的类，你再改就好了（

最后直接 `eval` 读 `flag.php` 就好了

### Saudi Arabia - 眼见为虚
我是不会做 APK 题的，但好像过的人很多，我就用力看了一下……我机器上的 APK 反编译一直配的有问题，然后我就开心地扔到在线反编译了（死

打开后发现主要有三个文件，其中两个很类似，一个是将两个字符数组做异或。两个类似的部分，一个两个字符数组都给出来了，但是是假 flag；另外的一个只有一个字符数组，另外一个是调用了一个 native 函数，于是从 apk 包里直接把 so 拿出来，ida 跑一下就完事了。


### Brazil - Base64-Encrypt
下载代码后整理加密流程如下：

1. key 是一个长度小于 14 的每一位在 0 ~ 255 的……就当做数字数组吧
2. xor 操作定义为对明文的每一位，取 key 的`位置 % key 长度` 与明文异或
3. 最后给出的密文是 `b64encode(xor(b64encode(xor(plain.encode(),key)),key))`

最气的是这个明明有 xortool 但 TM 跑不出来，好气啊，我不服！

不服怎么办，也要做啊……观察这个加密，核心问题在于去除外层 base64 后，xor 加密的是一个有明确字符集和规律的字符串，因此从这下手，我们设计解密脚本如下：

1. 枚举密钥长度
2. 计算对于某个位置的值，如果要让它变换到 base64 字符集范围下的可行集合
3. 由于密钥是循环的，因此对于某个密钥位置，可行集合是求交
4. 得到最后结果

由于最后交出来的可行集元素个数可能大于 1，所以还要再对这些可行集求一次笛卡尔积，分别尝试用于解码，最后即可得到结果。

代码见附件。


### Egypt - Stack Mess
这道题是真的吊，吊到无法理解的那种...

* 按惯例扔去解包，发现里面实现了一个奇怪的逻辑，看不太懂
* 刚好买了台新手机，扔进手机被告之要输入 999999 来得到答案，可以从小的试起也可以投机取巧
* 输入 999999 死机了，妈的辣鸡魅族
* 盯着代码看了半天还是没看懂，只知道是输入一个数输出一个数……
* 嗯？输入一个数输出一个数？这个题型很熟悉啊...

```
历史回顾：
在 ACM/ICPC 竞赛中，有一类题目被称为“输入一个数、输出一个数”，常常是数学题

本来这类题目难度也不小，然而出现了一个奇怪的网站，OEIS（The On-Line Encyclopedia of Integer Sequences），里面包含了你能想到的所有整数数列

后来，就再也没人出这类题了……
```

* 总而言之先试几个小的
* 打开 OEIS
* 找到了[规律](http://oeis.org/search?q=1%2C1%2C3%2C1%2C3%2C5%2C7%2C1%2C3%2C5%2C7%2C9%2C11&language=english&go=Search)
* 靠，好像对大一点的数也有用，试试
* 过了
* 。。。？？？（黑人问号.jpg）

于是这题正解到底是什么，我现在还不知道，但总而言之是过了……


好了不扯了，我个人是很喜欢这种题的，主要是……很有趣啊，从代码逻辑来看应该是模拟了这个数列的生成过程，但有些地方为什么能出结果我还是没太懂，感觉值得赛后再研究一下。给个满分！


### Italy - Vigenere-Encrypt
下载代码后整理加密流程如下：

1. 随机生成一个 key，key 是长度为 15 ~ 29 的一个数组，数组里面的数字范围都在 1 ~ 96 里。
2. 对明文，先在码表里找到下标，然后与 `key[位置 % key 长度]` 上的数字做乘法模 97，得到的数就是被替换成的字符在码表里的下标
3. 输出密文

这个题跟标题一样，实际上就是 Vigenere 加密的变种。对于古典加密，最有力的永远是频率分析，所以我们设计解密脚本如下：

0. 先枚举密钥长度
1. 对于每个密文，我们先计算“假设它明文是常见字符，key 应该是多少”（这里要求个逆元）
2. 对于得到的结果，我们为它在这个位置的可能性投一票
3. 最后将 key 每个位置上最有可能的一个数拿出来即可

因为常见字符总是较多，并且文章长、密钥短，所以总有大量常见字符被同一个密钥的位置加密了，因此投票真正的密钥会占据优势，因此就可以算出密钥了。

代码见附件。

我做出来的两道密码学题，我都十分喜欢，感觉还是很有趣的，然而能看出这两个题本质上其实是一个方法，有些重复了，拿掉其中一题换成另外做法的题可能会更好……